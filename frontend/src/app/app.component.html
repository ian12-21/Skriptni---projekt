<div class="container">
  <header>
    <h1>ğŸ›’ {{ title }}</h1>
    <p>Dnevne arhive cijena iz hrvatskih trgovina</p>
    
    <div class="harvester-status" *ngIf="harvesterStatus">
      <span class="status-badge" [class.active]="harvesterStatus.running">
        {{ harvesterStatus.running ? 'ğŸŸ¢ Harvester aktivan' : 'ğŸ”´ Harvester neaktivan' }}
      </span>
      <span class="status-badge fetching" *ngIf="harvesterStatus.currentlyFetching">
        â³ Preuzimanje u tijeku...
      </span>
      <span class="status-info" *ngIf="archiveDate">
        ğŸ“… Prikazani podaci: <strong>{{ archiveDate }}</strong>
      </span>
      <span class="status-info" *ngIf="harvesterStatus.lastResult && harvesterStatus.lastResult.records">
        ğŸ“Š Zadnji harvest: {{ harvesterStatus.lastResult.records | number }} zapisa
      </span>
    </div>
  </header>

  <div class="controls">
    <div class="button-group">
      <button class="btn-primary" (click)="triggerHarvest()" [disabled]="loading">
        {{ loading ? 'â³ Preuzimanje...' : 'ğŸ“¥ Dohvati najnovije' }}
      </button>
      <button class="btn-secondary" (click)="loadData()" [disabled]="loading">
        ğŸ”„ OsvjeÅ¾i
      </button>
      <button class="btn-info" (click)="toggleStats()">
        {{ showStats ? 'ğŸ“‰ Sakrij statistike' : 'ğŸ“Š Statistike' }}
      </button>
      <button class="btn-purple" (click)="toggleArchives()">
        {{ showArchives ? 'ğŸ“ Sakrij listu arhiva' : 'ğŸ“ Lista arhiva (download)' }}
      </button>
      <button class="btn-success" (click)="exportCSV()" [disabled]="data.length === 0">
        ğŸ’¾ Export CSV
      </button>
      <button (click)="exportToJson()" class="btn-success" [disabled]="data.length === 0">
        ğŸ“¥ Export JSON
      </button>
    </div>

    <div class="filters">
      <div class="filter-row">
        <div class="filter-group date-select">
          <label>ğŸ“… Datum podataka:</label>
          <select [(ngModel)]="selectedDate" (change)="onDateChange()" [disabled]="loading">
            <option value="">âœ¨ Najnovije (Lokalno)</option>
            <option *ngFor="let arch of archives" [value]="arch.date">
              {{ arch.date }} ({{ formatBytes(arch.size) }})
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label>Trgovina:</label>
          <select [(ngModel)]="filterTrgovina" (change)="applyFilters()">
            <option value="">Sve trgovine</option>
            <option *ngFor="let t of trgovine" [value]="t">{{ t }}</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Naziv proizvoda:</label>
          <input type="text" [(ngModel)]="filterNaziv" placeholder="PretraÅ¾i..." (keyup.enter)="applyFilters()" [disabled]="!!selectedDate" title="Pretraga po nazivu dostupna samo za najnovije podatke"/>
        </div>
      </div>
      
      <div class="filter-row">
        <div class="filter-group">
          <label>Kategorija:</label>
          <select [(ngModel)]="filterKategorija" (change)="applyFilters()" [disabled]="!!selectedDate">
            <option value="">Sve kategorije</option>
            <option *ngFor="let k of kategorije" [value]="k">{{ k }}</option>
          </select>
        </div>
        
        <div class="filter-group">
          <label>Brand:</label>
          <input type="text" [(ngModel)]="filterBrand" placeholder="Marka..." (keyup.enter)="applyFilters()" [disabled]="!!selectedDate"/>
        </div>

        <div class="filter-group small">
          <label>Min â‚¬:</label>
          <input type="number" [(ngModel)]="minCijena" placeholder="0" (keyup.enter)="applyFilters()" [disabled]="!!selectedDate"/>
        </div>
        
        <div class="filter-group small">
          <label>Max â‚¬:</label>
          <input type="number" [(ngModel)]="maxCijena" placeholder="1000" (keyup.enter)="applyFilters()" [disabled]="!!selectedDate"/>
        </div>
        
        <div class="filter-group">
          <label>Grad:</label>
          <input type="text" [(ngModel)]="filterGrad" placeholder="Grad..." (keyup.enter)="applyFilters()" [disabled]="!!selectedDate"/>
        </div>
        
        <button class="btn-primary" (click)="applyFilters()" [disabled]="loading">ğŸ” PretraÅ¾i</button>
        <button class="btn-warning" (click)="clearFilters()" [disabled]="loading">âœ– OÄisti</button>
      </div>
      
      <div class="filter-note" *ngIf="selectedDate">
        â„¹ï¸ <em>Napomena: Za povijesne arhive dostupno je samo filtriranje po trgovini.</em>
      </div>
    </div>
  </div>

  <div class="stats-section" *ngIf="showStats && stats">
    <h2>ğŸ“Š Statistike {{ selectedDate ? '(' + selectedDate + ')' : '(Najnovije)' }}</h2>
    <div class="stats-grid">
      <div class="stat-card blue">
        <div class="stat-value">{{ stats.stats.totalRecords | number }}</div>
        <div class="stat-label">Ukupno zapisa</div>
      </div>
      <div class="stat-card green">
        <div class="stat-value">{{ stats.stats.avgCijena | number:'1.2-2' }} â‚¬</div>
        <div class="stat-label">ProsjeÄna cijena</div>
      </div>
      <div class="stat-card red">
        <div class="stat-value">{{ stats.stats.minCijena | number:'1.2-2' }} â‚¬</div>
        <div class="stat-label">NajniÅ¾a cijena</div>
      </div>
      <div class="stat-card orange">
        <div class="stat-value">{{ stats.stats.maxCijena | number:'1.2-2' }} â‚¬</div>
        <div class="stat-label">NajviÅ¡a cijena</div>
      </div>
      <div class="stat-card purple">
        <div class="stat-value">{{ stats.stats.uniqueTrgovine }}</div>
        <div class="stat-label">Trgovina</div>
      </div>
      <div class="stat-card teal">
        <div class="stat-value">{{ stats.stats.uniqueKategorije }}</div>
        <div class="stat-label">Kategorija</div>
      </div>
    </div>
  </div>

  <div class="archives-section" *ngIf="showArchives">
    <h2>ğŸ“ Dostupne arhive na cijene.dev (Download)</h2>
    <div class="archives-list" *ngIf="archives && archives.length > 0">
      <div class="archive-item" *ngFor="let archive of archives">
        <span class="archive-date">ğŸ“… {{ archive.date }}</span>
        <span class="archive-size">{{ formatBytes(archive.size) }}</span>
        <a [href]="archive.url" target="_blank" class="archive-link">â¬‡ï¸ Preuzmi ZIP</a>
      </div>
    </div>
    <div class="loading-text" *ngIf="!archives || archives.length === 0">UÄitavanje liste arhiva...</div>
  </div>

  <div class="alert alert-success" *ngIf="message">âœ… {{ message }}</div>
  <div class="alert alert-error" *ngIf="error">âŒ {{ error }}</div>
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
    <div class="loading-text-overlay">
      â³ {{ selectedDate ? 'Preuzimanje i obrada arhive...' : 'UÄitavanje podataka...' }}
    </div>
  </div>

  <div class="data-section" *ngIf="!loading">
    <div class="data-header">
      <h2>ğŸ“‹ Proizvodi <span class="count">({{ totalRecords | number }})</span></h2>
      
      <div class="pagination" *ngIf="totalPages > 1">
        <button class="btn-page" (click)="prevPage()" [disabled]="currentPage === 1">â† Prethodna</button>
        <span class="page-info">{{ currentPage }} / {{ totalPages }}</span>
        <button class="btn-page" (click)="nextPage()" [disabled]="currentPage === totalPages">SljedeÄ‡a â†’</button>
      </div>
    </div>
    
    <div class="no-data" *ngIf="data.length === 0">
      <p>Nema podataka za prikaz.</p>
      <p *ngIf="!selectedDate">Kliknite "Dohvati najnovije" za preuzimanje svjeÅ¾ih podataka.</p>
    </div>

    <div class="table-container" *ngIf="data && data.length > 0">
      <table>
        <thead>
          <tr>
            <th>Naziv</th>
            <th>Trgovina</th>
            <th>Kategorija</th>
            <th>Brand</th>
            <th>Cijena</th>
            <th>Jed. cijena</th>
            <th>Najbolja 30d</th>
            <th>Jedinica</th>
            <th>Grad</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of data">
            <td class="naziv-cell" [title]="item.naziv">{{ item.naziv }}</td>
            <td><span class="trgovina-badge" [attr.data-store]="item.trgovina.toLowerCase()">{{ item.trgovina }}</span></td>
            <td>{{ item.kategorija }}</td>
            <td>{{ item.brand || '-' }}</td>
            <td class="cijena-cell">{{ formatCijena(item.cijena) }}</td>
            <td>{{ formatCijena(item.cijena_jedinicna) }}</td>
            <td class="best-price" *ngIf="item.najbolja_cijena_30">{{ formatCijena(item.najbolja_cijena_30) }}</td>
            <td *ngIf="!item.najbolja_cijena_30">-</td>
            <td>{{ item.jedinica }} {{ item.kolicina }}</td>
            <td>{{ item.grad || '-' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div class="pagination bottom" *ngIf="totalPages > 1 && data && data.length > 0">
      <button class="btn-page" (click)="prevPage()" [disabled]="currentPage === 1">â† Prethodna</button>
      <span class="page-info">Stranica {{ currentPage }} od {{ totalPages }}</span>
      <button class="btn-page" (click)="nextPage()" [disabled]="currentPage === totalPages">SljedeÄ‡a â†’</button>
    </div>
  </div>
</div>